#!/bin/bash
#
#  $Id$
# 
#  This file is part of Vidalia, and is subject to the license terms in the
#  LICENSE file, found in the top level directory of this distribution. If you
#  did not receive the LICENSE file with this file, you may obtain it from the
#  Vidalia source package distributed by the Vidalia Project at
#  http://www.vidalia-project.net/. No part of Vidalia, including this file,
#  may be copied, modified, propagated, or distributed except according to the
#  terms described in the LICENSE file.
#
##############################################################################

# Make sure enough arguments were supplied
if [ "$#" -eq 0 ]; then
  echo "This is normally called by package.sh in the pkg dir."
  exit 1
fi

# Make sure the source directory exists
srcdir=$1
if [ ! -d "$srcdir" ]; then
  echo "Specified source directory doesn't exit: $srcdir"
  exit 1
fi
echo "Source Directory: $srcdir"

# Determine OSX Version and map version to name
if [ -x /usr/bin/sw_vers ]; then
  # This is poor, yet functional.  We don't care about the 3rd number in
  # the OS version
  OSVER=`/usr/bin/sw_vers | grep ProductVersion | cut -f2 | cut -d"." -f1,2`
  case "$OSVER" in
    "10.6") ARCH="universal";;
    "10.5") ARCH="universal";;
    "10.4") ARCH="universal";;
    "10.3") ARCH="ppc";;
    "10.2") ARCH="ppc";;
    "10.1") ARCH="ppc";;
    "10.0") ARCH="ppc";;
         *) ARCH="unknown";;
  esac
else
  ARCH="unknown"
fi

# Set the location of the temporary files
BUILD_DIR=/tmp/vidalia-osx-$$
# Set the Vidalia version
VERSION="@VERSION@"
# Set the Tor version
TORVERSION="$4"
# Set the name of the output .dmg file
if [ $3 = "bundle" ]; then
  DMG="vidalia-bundle-$TORVERSION-$VERSION-$ARCH.dmg"
else
  DMG="vidalia-$VERSION-$ARCH.dmg"
fi

# Get the rest of the command-line arguments
filelist=$2
echo "Files to copy: $filelist"
echo "Destination Disk Image: $DMG"
volname=`echo "$DMG" | sed -e "s/.*\///" | sed -e "s/.dmg//"`
echo "Volume Name: $volname"

# Create the temporary directory
mkdir $BUILD_DIR || exit 1

# Copy over the specified files into the disk image
for file in $filelist
do
  echo "Copying $srcdir/$file to $BUILD_DIR/$file"
  cp -r "$srcdir/$file" "$BUILD_DIR/$file"
done
ln -s /Applications $BUILD_DIR/Applications

# Create the disk image
hdiutil create -format UDZO -imagekey zlib-level=9 -srcfolder "$BUILD_DIR" -volname "$volname" "$DMG"
rm -rf "$BUILD_DIR"

